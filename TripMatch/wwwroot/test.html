<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ThinkTripMatch 功能測試面板</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            line-height: 1.6;
        }

        .section {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .btn {
            padding: 8px 15px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }

        .btn-green {
            background-color: #28a745;
        }

        .log {
            background: #f4f4f4;
            padding: 10px;
            height: 150px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid #ddd;
        }

        input {
            padding: 5px;
            margin: 5px 0;
        }
    </style>
</head>
<body>

    <h1>行程共編測試工具</h1>

    <div class="section">
        <h3>1. 身分管理 (組員 A)</h3>
        <p>點擊下方按鈕會自動在資料庫建立一個假會員，並透過 <code>AuthToken</code> Cookie 登入。</p>
        <button class="btn" onclick="generateUser()">新增假會員並登入</button>
        <button class="btn" style="background-color: #dc3545;" onclick="logout()">登出</button>
        <div id="userInfo" style="margin-top: 10px; font-weight: bold; color: blue;">目前狀態：未登入</div>
    </div>

    <div class="section">
        <h3>2. 行程編輯測試 (組員 B)</h3>
        <p>測試後端如何攔截請求並比對 <code>UserId</code>。</p>
        <div>
            行程 ID: <input type="number" id="tripId" placeholder="輸入資料庫中的 TripId"><br>
            行程標題: <input type="text" id="tripTitle" placeholder="新的行程名稱">
        </div>
        <button class="btn btn-green" onclick="editTrip()">呼叫編輯 API (PUT)</button>
    </div>

    <div class="section">
        <h3>執行結果 Log</h3>
        <div id="logConsole" class="log">等待操作...</div>
    </div>

    <script>
        const logConsole = document.getElementById('logConsole');
        const userInfo = document.getElementById('userInfo');

        function addLog(msg, isError = false) {
            const time = new Date().toLocaleTimeString();
            const color = isError ? 'red' : 'black';
            logConsole.innerHTML += `<div style="color: ${color}">[${time}] ${msg}</div>`;
            logConsole.scrollTop = logConsole.scrollHeight;
        }

        // 組員 A: 產生使用者
        async function generateUser() {
            try {
                addLog("正在產生假會員...");
                const response = await fetch('/api/auth/test-generate-user', { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    addLog(`登入成功！ID: ${data.userId}, 帳號: ${data.userName}`);
                    userInfo.innerText = `目前登入：${data.userName} (ID: ${data.userId})`;
                } else {
                    addLog("失敗: " + data.message, true);
                }
            } catch (err) {
                addLog("連線錯誤", true);
            }
        }

        // 登出
        async function logout() {
            await fetch(window.Routes.AuthApi.Logout, { method: 'POST' });
            userInfo.innerText = "目前狀態：已登出";
            addLog("已登出，Cookie 已清除");
        }

        // 組員 B: 編輯行程
        async function editTrip() {
            const tripId = document.getElementById('tripId').value;
            const title = document.getElementById('tripTitle').value;

            if (!tripId) {
                alert("請輸入行程 ID");
                return;
            }

            try {
                addLog(`嘗試編輯行程 ID: ${tripId}...`);
                // 注意：因為使用 HttpOnly Cookie，這裡不需要手動加 Authorization Header
                const response = await fetch(`/api/trip/edit/${tripId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: title })
                });

                if (response.status === 200) {
                    addLog("成功：行程已更新！", false);
                } else if (response.status === 401) {
                    addLog("失敗：401 未登入 (Token 無效或不存在)", true);
                } else if (response.status === 403) {
                    addLog("失敗：403 Forbidden (你是會員，但你不是此行程的擁有者)", true);
                } else {
                    const errorMsg = await response.text();
                    addLog(`錯誤 (${response.status}): ${errorMsg}`, true);
                }
            } catch (err) {
                addLog("連線錯誤", true);
            }
        }
    </script>
</body>
</html>