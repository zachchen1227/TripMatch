@{
    ViewData["Title"] = "確認行程時間";
    // 接收後端傳來的旗標 (轉成小寫 js boolean)
    var hasData = (ViewBag.HasCalendarData as bool?) ?? false;
    string hasDataJs = hasData.ToString().ToLower();
}

<link rel="stylesheet" href="~/css/AuthApi/Calendar.css" />

<style>
    /* === 1. 原本行事曆頁面的樣式 === */
    .page-wrap {
        padding: 40px 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .calendar-container {
        background: #fff;
        border-radius: 20px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.08);
        padding: 30px;
    }

    .section-title {
        font-size: 24px;
        font-weight: 800;
        text-align: center;
        margin-bottom: 10px;
        color: #111827;
    }

    .section-desc {
        text-align: center;
        color: #6b7280;
        font-size: 14px;
        margin-bottom: 30px;
    }

    .day-cell.selected-single {
        background-color: #16a34a !important;
        color: #fff !important;
    }

    .day-cell.locked {
        background-color: #f3f4f6;
        color: #d1d5db;
        cursor: not-allowed;
        pointer-events: none;
    }

    .btn-action {
        border-radius: 12px;
        font-weight: 700;
        padding: 12px 24px;
    }

    /* === 2. Modal 專用樣式 (整合版) === */
    :root {
        --overlay-bg: rgba(0, 0, 0, 0.6);
        --modal-bg: #FFFFFF;
        --text-primary: #111928;
        --text-secondary: #6B7280;
        --primary-blue: #155DFC;
        --primary-blue-hover: #104AB8;
        --icon-bg-top: #DBEAFE;
        --card-bg: #F9FAFB;
        --border-color: #E5E7EB;
        --icon-blue: #155DFC;
        --icon-green: #22C55E;
        --icon-purple: #A855F7;
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--overlay-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999; /* 確保在最上層 */
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s;
        padding: 20px;
    }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

    .custom-modal {
        background: var(--modal-bg);
        width: 100%;
        max-width: 560px;
        border-radius: 24px;
        box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        padding: 40px;
        position: relative;
        transform: scale(0.95);
        transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        max-height: 95vh;
        overflow-y: auto;
    }

    .modal-overlay.active .custom-modal {
        transform: scale(1);
    }

    .close-btn {
        position: absolute;
        top: 24px;
        right: 24px;
        background: transparent;
        border: none;
        color: #9CA3AF;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
    }

        .close-btn:hover {
            background-color: #F3F4F6;
            color: #4B5563;
        }

    .header-icon {
        width: 84px;
        height: 84px;
        background-color: var(--icon-bg-top);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 24px auto;
        color: var(--primary-blue);
    }

    .modal-title {
        color: var(--text-primary);
        font-size: 28px;
        font-weight: 700;
        text-align: center;
        margin-bottom: 12px;
    }

    .modal-subtitle {
        color: var(--text-secondary);
        font-size: 16px;
        text-align: center;
        margin-bottom: 32px;
    }

    .feature-card {
        background-color: var(--card-bg);
        border-radius: 16px;
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-bottom: 32px;
    }

    .feature-row {
        display: flex;
        align-items: flex-start;
        gap: 16px;
    }

    .feature-icon-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        color: white;
    }

    .icon-blue {
        background-color: var(--icon-blue);
    }

    .icon-green {
        background-color: var(--icon-green);
    }

    .icon-purple {
        background-color: var(--icon-purple);
    }

    .feature-text h4 {
        font-size: 16px;
        font-weight: 700;
        margin-bottom: 4px;
        color: var(--text-primary);
    }

    .feature-text p {
        font-size: 14px;
        color: var(--text-secondary);
        margin: 0;
    }

    .btn-group-modal {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .btn-modal {
        width: 100%;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: 0.2s;
    }

    .btn-modal-primary {
        height: 64px;
        border-radius: 16px;
        background-color: var(--primary-blue);
        color: white;
        font-size: 18px;
        font-weight: 600;
    }

        .btn-modal-primary:hover {
            background-color: var(--primary-blue-hover);
        }

    .btn-modal-secondary {
        height: 56px;
        border-radius: 16px;
        background-color: white;
        border: 1px solid var(--border-color);
        color: #4B5563;
        font-size: 16px;
        font-weight: 600;
    }

        .btn-modal-secondary:hover {
            background-color: #F3F4F6;
        }
</style>

<div class="page-wrap">

    <div class="calendar-container">
        <h2 class="section-title">確認您的可用時間</h2>
        <p class="section-desc">系統已自動帶入您在會員中心的設定，請確認本次行程的可用時段</p>

        <div class="calendar_legend mb-3 text-center">
            <span class="legend-item"><span class="dot today"></span>今天</span>
            <span class="legend-item"><span class="dot locked"></span>非揪團期間</span>
            <span class="legend-item"><span class="dot" style="background:#16a34a;"></span>我可以參加 (可用)</span>
        </div>

        <div class="container p-0">
            <div class="row g-3 align-items-start">
                <div class="col-sm-12 col-md-3 months-panel">
                    <header class="year-header d-flex justify-content-between align-items-center">
                        <button class="year-left btn btn-sm btn-link">◀</button>
                        <div class="year-display">2026</div>
                        <button class="year-right btn btn-sm btn-link">▶</button>
                    </header>
                    <div class="months-grid mt-2"></div>
                </div>

                <div class="col-sm-12 col-md-6 month-panel">
                    <header class="month-header d-flex justify-content-between align-items-center">
                        <button class="month-left btn btn-sm btn-link">◀</button>
                        <div class="month-display">January 2026</div>
                        <button class="month-right btn btn-sm btn-link">▶</button>
                    </header>

                    <div class="week mt-2 d-flex justify-content-between small text-muted">
                        <div>週一</div><div>週二</div><div>週三</div><div>週四</div><div>週五</div><div>週六</div><div>週日</div>
                    </div>

                    <div class="days mt-2"></div>
                </div>

                <aside class="col-sm-12 col-md-3 list-panel">
                    <div class="list-header mb-2">
                        <h5 class="mb-0">已選日期</h5>
                        <small class="text-muted" id="selectedCount">0 天</small>
                    </div>
                    <div id="calendarList" class="calendar-list"></div>
                </aside>
            </div>

            <div class="row mt-4">
                <div class="col-12 text-center">
                    <button id="btnSubmit" class="btn btn-primary btn-action w-50">
                        確認提交，下一步
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="askCalendarModal">
    <div class="custom-modal">
        <button class="close-btn" onclick="closeModal()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>

        <div class="header-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" width="42" height="42">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
        </div>

        <h1 class="modal-title">設定你的行事曆</h1>
        <p class="modal-subtitle">同步您的行事曆，讓時間媒合更快速、更準確</p>

        <div class="feature-card">
            <div class="feature-row">
                <div class="feature-icon-circle icon-blue"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg></div>
                <div class="feature-text"><h4>自動偵測可用時間</h4><p>系統會自動分析您的行事曆，標示出可以出發的日期</p></div>
            </div>
            <div class="feature-row">
                <div class="feature-icon-circle icon-green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg></div>
                <div class="feature-text"><h4>一次設定，永久使用</h4><p>之後每次時間媒合都可以直接帶入，省去重複設定的麻煩</p></div>
            </div>
            <div class="feature-row">
                <div class="feature-icon-circle icon-purple"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                <div class="feature-text"><h4>提高協調效率</h4><p>減少人工輸入錯誤，讓團隊更快找到共同時間</p></div>
            </div>
        </div>

        <div class="btn-group-modal">
            <button class="btn-modal btn-modal-primary" onclick="goToMemberCenter()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                前往設定行事曆
            </button>
            <button class="btn-modal btn-modal-secondary" onclick="closeModal()">先跳過，稍後再設定</button>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/AuthApi/Datehelper.js"></script>

    <script>
        // Modal 控制邏輯
        const modal = document.getElementById('askCalendarModal');
        // 從後端接收變數 (C# -> JS)
        const hasCalendarData = @hasDataJs;

        document.addEventListener('DOMContentLoaded', function() {
            // 如果沒資料 (false) -> 顯示 Modal
            // 如果有資料 (true) -> Modal 保持隱藏 (opacity:0)
            if (!hasCalendarData) {
                modal.classList.add('active');
            }
        });

        function closeModal() {
            modal.classList.remove('active');
        }

        function goToMemberCenter() {
            // 跳轉至會員中心 (請確認網址是否正確)
            window.location.href = '/Auth/MemberCenter#calendar_section';
        }

        // ==========================================
        // 以下為原本的行事曆 JS (無更動，僅保留功能)
        // ==========================================
        (function() {
            const groupId = '@ViewBag.GroupId';
            let currentYear = new Date().getFullYear();
            let currentMonth = new Date().getMonth();
            let selectedDates = [];
            let groupStart = null;
            let groupEnd = null;

            document.addEventListener('DOMContentLoaded', async function() {
                await Promise.all([loadGroupInfo(), loadMyAvailability()]);
                buildMonthPanel();
                renderMonth();
                bindEvents();
            });

            async function loadGroupInfo() {
                try {
                    const res = await fetch(`/api/timewindow/${groupId}/status`);
                    if(res.ok) {
                        const data = await res.json();
                        groupStart = data.dateStart;
                        groupEnd = data.dateEnd;
                        const d = new Date(groupStart);
                        currentYear = d.getFullYear();
                        currentMonth = d.getMonth();
                    }
                } catch(e) { console.error("無法取得群組資訊", e); }
            }

            async function loadMyAvailability() {
                try {
                    const res = await fetch('/api/auth/GetLeaves');
                    if(res.ok) {
                        const data = await res.json();
                        if(data.dates && Array.isArray(data.dates)) {
                            data.dates.forEach(d => {
                                if(!selectedDates.includes(d)) selectedDates.push(d);
                            });
                        }
                    }
                } catch(e) { console.error("無法取得個人可用時間", e); }
            }

            function isLocked(iso) {
                if (!groupStart || !groupEnd) return false;
                return iso < groupStart || iso > groupEnd;
            }

            function renderMonth() {
                const $days = document.querySelector('.days');
                const $title = document.querySelector('.month-display');

                const firstDay = new Date(currentYear, currentMonth, 1);
                $title.textContent = firstDay.toLocaleString('default', { month: 'long', year: 'numeric' });
                $days.innerHTML = '';

                const startDay = (firstDay.getDay() + 6) % 7;
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

                for(let i=0; i<startDay; i++) {
                    $days.innerHTML += `<div class="day-cell empty"></div>`;
                }

                for(let d=1; d<=daysInMonth; d++) {
                    const date = new Date(currentYear, currentMonth, d);
                    const z = date.getTimezoneOffset() * 60 * 1000;
                    const iso = new Date(date - z).toISOString().split('T')[0];

                    const cell = document.createElement('div');
                    cell.className = 'day-cell';
                    cell.textContent = d;

                    if (isLocked(iso)) {
                        cell.classList.add('locked');
                    } else {
                        if (selectedDates.includes(iso)) {
                            cell.classList.add('selected-single');
                        }
                        cell.onclick = () => toggleDate(iso);
                    }
                    $days.appendChild(cell);
                }

                renderList();
            }

            function toggleDate(iso) {
                if (selectedDates.includes(iso)) {
                    selectedDates = selectedDates.filter(d => d !== iso);
                } else {
                    selectedDates.push(iso);
                }
                renderMonth();
            }

            function renderList() {
                const validSelection = selectedDates.filter(d => !isLocked(d)).sort();
                const $list = document.getElementById('calendarList');
                $list.innerHTML = validSelection.map(iso => `<div class="calendar-range-item">${iso}</div>`).join('');
                document.getElementById('selectedCount').textContent = `${validSelection.length} 天`;
            }

            function buildMonthPanel() {
                const $grid = document.querySelector('.months-grid');
                document.querySelector('.year-display').textContent = currentYear;
                $grid.innerHTML = '';
                for(let m=0; m<12; m++) {
                    const btn = document.createElement('div');
                    btn.className = `month-btn ${m === currentMonth ? 'active' : ''}`;
                    btn.innerHTML = `<div class="mn">${m+1} 月</div>`;
                    btn.onclick = () => { currentMonth = m; renderMonth(); updateMonthActive(); };
                    $grid.appendChild(btn);
                }
            }

            function updateMonthActive() {
                document.querySelectorAll('.month-btn').forEach((btn, idx) => {
                    btn.classList.toggle('active', idx === currentMonth);
                });
            }

            function bindEvents() {
                document.querySelector('.year-left').onclick = () => { currentYear--; buildMonthPanel(); renderMonth(); };
                document.querySelector('.year-right').onclick = () => { currentYear++; buildMonthPanel(); renderMonth(); };
                document.querySelector('.month-left').onclick = () => { currentMonth--; if(currentMonth < 0) { currentMonth = 11; currentYear--; } renderMonth(); updateMonthActive(); };
                document.querySelector('.month-right').onclick = () => { currentMonth++; if(currentMonth > 11) { currentMonth = 0; currentYear++; } renderMonth(); updateMonthActive(); };

                document.getElementById('btnSubmit').onclick = async function() {
                    const validDates = selectedDates.filter(d => !isLocked(d));
                    if(validDates.length === 0 && !confirm("您沒有選擇任何可用日期，確定要提交嗎？")) return;

                    const slots = validDates.map(d => ({ startAt: d + "T00:00:00", endAt: d + "T23:59:59" }));
                    const btn = this;
                    btn.disabled = true;
                    btn.innerText = "提交中...";

                    try {
                        const res = await fetch(`/api/timewindow/${groupId}/available`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(slots)
                        });

                        if(res.ok) {
                            //window.location.href = `/Match/Preferences/${groupId}`;
                        } else {
                            const err = await res.json();
                            alert("提交失敗：" + (err.message || "未知錯誤"));
                            btn.disabled = false;
                            btn.innerText = "確認提交，下一步";
                        }
                    } catch(e) {
                        console.error(e);
                        alert("連線錯誤");
                        btn.disabled = false;
                        btn.innerText = "確認提交，下一步";
                    }
                };
            }
        })();
    </script>
}