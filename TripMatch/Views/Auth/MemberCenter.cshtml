@using System.Security.Claims
@{
    ViewData["Title"] = "會員中心";
    Layout = "~/Views/Shared/_LoginLayout.cshtml";

    var avatarUrl = User.FindFirst("Avatar")?.Value;
    if (string.IsNullOrEmpty(avatarUrl))
    {
        avatarUrl = Url.Content("~/img/default_avatar.png");
    }

    var currentUserId = User.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? "0";
}
@section Styles{
    <link href="~/css/AuthApi/Calendar.css" rel="stylesheet" />
    <link href="~/css/AuthApi/member.css" rel="stylesheet" />
    <style>
        body {
            background-color: var(--light) !important;/*單獨*/
        }
    </style>
}



<div class="member_center_wrap container">

    <!-- =============================================
         區塊一：個人資料
         ============================================= -->
    <section class="member_section" id="profile_section">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="mb-0 titleWrap titleH2">個人資料</h1>

        </div>

        @* <!-- 通知列 -->
        <div class="notification_bar">
            <i class="bi bi-bell"></i>
        </div> *@

        <div class="profile_container row g-4">
            @* g-4 增加左右間距 *@

            <div class="profile_avatar_section col-12 col-md-6 d-flex flex-column align-items-center justify-content-center">
                <div class="avatar_frame">
                    <img src="@avatarUrl" alt="會員頭像" id="memberAvatar" class="memberAvatar">
                </div>
                <input type="file" id="avatarInput" accept="image/jpeg,image/png,image/gif,image/webp"
                       style="position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden;" />

                <div class="avatar_btns mt-3">
                    <button type="button" class="btn btn_light btn-sm" id="btnEditAvatar">編輯頭像</button>
                </div>
                    <button type="button" class="btn btn_Gray btn-sm" id="btnLogout">登 出</button>
            </div>

            <div class="profile_info_section col-12 col-md-6">
                <div class="info_row">
                    <div class="info_item mb-4">
                        <label class="info_label"><i class="bi bi-square-fill text-success me-2"></i>帳號</label>
                        <div class="info_value d-flex align-items-center gap-2">
                            <span id="displayEmail">example@gmail.com</span>
                            <input id="inputEmail" type="email" class="form-control d-none" />

                        </div>
                      <div class="info_item mb-4">
                        <label class="info_label name_label"><i class="bi bi-square-fill text-success me-2"></i>自訂名稱</label>
                        <div class="info_value d-flex align-items-center gap-2">
                            <span id="displayName">example</span>
                            <input id="inputName" type="text" class="form-control d-none" />
                            <button id="btnEditName" class="btn btn_link edit_link p-0">編輯</button>
                            <button id="btnSaveName" class="btn btn_light btn-sm d-none">確認</button>
                            <button id="btnCancelName" class="btn btn_light btn-sm d-none">取消</button>
                        </div>
                    </div>

                    </div>
                </div>

                <div class="info_row">
                    <div class="info_item mb-4">
                        <label class="info_label"><i class="bi bi-square-fill text-warning me-2"></i>備援信箱</label>
                        <div class="info_value d-flex align-items-center gap-2">
                            <span id="displayBackupEmail">example2@gmail.com</span>
                            <input id="inputBackupEmail" type="email" class="form-control d-none" />
                            <button id="btnEditBackupEmail" class="btn btn_link edit_link p-0">編輯</button>
                            <button id="btnSaveBackupEmail" class="btn btn_light btn-sm d-none">寄驗證信</button>
                            <button id="btnCancelBackupEmail" class="btn btn_light btn-sm d-none">取消</button>
                        </div>
                    </div>
                            <div id="emailHint" class="emailHint d-block "></div>
                    <div class="info_item">
                        <div>
                            <a href="@Url.Action("ChangePassword", "Auth")" class="nfo_label edit_link">修改密碼</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- =============================================
         區塊二：個人行事曆
         ============================================= -->
    <section class="member_section" id="calendar_section">
        <h2 class="titleWrap titleH2">個人行事曆</h2>

        <div class="calendar_legend mb-3">
            <span class="legend-item"><span class="dot today"></span>藍色圈：今天</span>
            <span class="legend-item"><span class="dot locked"></span>灰色圈：已有行程（不可選）</span>
            <span class="legend-item"><span class="dot range"></span>淡藜綠色圈（開始：粉藍；結束：橘）：範圍選擇</span>
            <span class="legend-item"><span class="dot ok"></span>藍綠色：舊提交</span>
            <span class="legend-item"><span class="dot ok2"></span>深藍色：新提交</span>
            <span class="legend-item" id="CalendarHint">會員如果需要單日，則日期點兩下</span>
        </div>

        <div class="container">
            <div class="row g-3 align-items-start">
                <!-- 左：月份選擇器 -->
                <div class="col-sm-12 col-md-3 months-panel">
                    <header class="year-header d-flex justify-content-between align-items-center">
                        <button class="year-left btn btn-sm btn-link">◀</button>
                        <div class="year-display">2026</div>
                        <button class="year-right btn btn-sm btn-link">▶</button>
                    </header>

                    <div class="months-grid mt-2"></div>
                </div>

                <!-- 中：日曆 -->
                <div class="col-sm-12 col-md-6 month-panel">
                    <header class="month-header d-flex justify-content-between align-items-center">
                        <button class="month-left btn btn-sm btn-link">◀</button>
                        <div class="month-display">January 2026</div>
                        <button class="month-right btn btn-sm btn-link">▶</button>
                    </header>

                    <div class="week mt-2 d-flex justify-content-between small text-muted">
                        <div>週一</div>
                        <div>週二</div>
                        <div>週三</div>
                        <div>週四</div>
                        <div>週五</div>
                        <div>週六</div>
                        <div>週日</div>
                    </div>

                    <div class="days mt-2"></div>

                    <div class="display-selected mt-3">
                        <p class="selected"></p>
                    </div>
                </div>

                <!-- 右：清單（草稿 + 已提交） -->
                <aside class="col-sm-12 col-md-3 list-panel">
                    <div class="list-header mb-2">
                        <h5 class="mb-0">目前選擇</h5>
                        <small class="text-muted">提示</small>
                    </div>

                    <div id="calendarList" class="calendar-list" aria-live="polite" role="region">
                        @* 由 Calendar.js 填入，每列格式如 "2026年1月1日" *@
                    </div>
                </aside>
            </div>

            @* 共用按鈕放在底部一列，手機會縮滿寬度 *@
            <div class="row mt-3">
                <div class="col-12 d-flex gap-2 flex-wrap">
                    <button class="confirm btn btn-primary">提交</button>
                    <button class="edit btn btn-secondary">開始編輯</button>
                    <button class="btn-delete btn btn-outline-danger">刪除</button>

                    <!-- 匯入 JSON 日曆 -->
                    <input type="file" id="importCalendarInput" accept=".json" style="display:none;" />
                    <button type="button" id="btnImportCalendar" class="btn btn-outline-primary">匯入 JSON 日曆</button>
                </div>

                <div class="col-12">
                    <div id="importCalendarMessage" class="alert d-none mt-3" role="alert" style="max-width:600px;"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- =============================================
         區塊三：願望清單
         ============================================= -->


        <!-- 願望清單卡片容器：由 wishlist.js 動態塞入 -->
        @model IEnumerable<TripMatch.Models.Settings.WishlistCard>
        @{
            ViewData["Title"] = "會員中心";
            // 確保 Model 即使為空也不會導致崩潰
            var cards = Model ?? Enumerable.Empty<TripMatch.Models.Settings.WishlistCard>();
        }

        <section class="member_section" id="wishlist_section">
            <div class="section_header d-flex align-items-center justify-content-between">
                <h2 class="titleWrap titleH2">願望清單</h2>
                <div class="edit_cards_link text-muted small">
                    <i class="bi bi-info-circle me-1"></i>點擊 View More 查看詳情
                </div>
            </div>

            <div class="wishlist_cards_container container mt-4" id="wishlistCardsContainer">
                @* 修正 ID 命名，確保與 JS 一致 *@
                <div id="wishlist_cards" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-3">
                    @if (!cards.Any())
                    {
                        <div class="col-12 text-center py-5">
                            <p class="text-muted">目前沒有願望清單，快去探索景點吧！</p>
                        </div>
                    }
                    else
                    {
                        @foreach (var item in cards)
                        {
                            <div class="col">
                                <div class="card h-100 shadow-sm border-0 position-relative wishlist-item">
                                    @* 移除收藏按鈕 (愛心) *@
                                    <button type="button" class="btn_remove_wish active" data-spotid="@item.SpotID"
                                            title="從清單移除"
                                            style="position:absolute; top:10px; right:10px; z-index:10; border:none; background:rgba(255,255,255,0.8); border-radius:50%; width:32px; height:32px; color:#dc3545; display:flex; align-items:center; justify-content:center;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-suit-heart-fill" viewBox="0 0 16 16">
                                        <path d="M4 1c2.21 0 4 1.755 4 3.92C8 2.755 9.79 1 12 1s4 1.755 4 3.92c0 3.263-3.234 4.414-7.608 9.608a.513.513 0 0 1-.784 0C3.234 9.334 0 8.183 0 4.92 0 2.755 1.79 1 4 1" />
                                    </svg>
                                    </button>

                                    <img src="@item.FirstImageUrl" class="card-img-top" alt="@item.Name_ZH"
                                         style="height: 180px; object-fit: cover; border-top-left-radius: 8px; border-top-right-radius: 8px;">

                                    <div class="card-body">
                                        <h6 class="card-title text-truncate fw-bold mb-1">@item.Name_ZH</h6>
                                        <p class="card-text small text-muted">景點編號: #@item.SpotID</p>
                                    </div>

                                    <div class="card-footer bg-transparent border-0 pb-3">
                                        <button class="btn btn-primary w-100 btn-view-more" data-id="@item.SpotID">
                                            View More
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </section>
        @* 全域的 View more 連結移除（每張卡片會由前端產生其 own View more） *@

    <button id="btnResetEmail" class="btn btn_Gray p-0">重設帳戶</button>
</div>
<a href="@Url.Action("Index", "Home")" class="back-home-link">
    回到首頁
</a>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">


@section Scripts {
    <script src="~/js/AuthApi/Datehelper.js" asp-append-version="true"></script>
    <script src="~/js/AuthApi/Calendar.js" asp-append-version="true"></script>
    <script src="~/js/AuthApi/wishlist.js" asp-append-version="true"></script>
    <script src="~/js/AuthApi/memberCenter.js" asp-append-version="true"></script>
    <script src="~/js/AuthApi/logout.js" asp-append-version="true"></script>


    <script>
    </script>
}


